name: CI/CD - Deploy to Staging

on:
  push:
    branches: [ "master" ]    # âœ… Run only when pushing to master branch
  workflow_dispatch: {}        # âœ… Optional manual trigger (from GitHub UI)

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: staging       # âœ… Pulls all environment variables from your "staging" environment

    container:
      image: node:20           # âœ… Runs all steps inside Node.js 20 Docker image

    steps:
      # ðŸ§© Step 1: Checkout your code
      - name: Checkout repository
        uses: actions/checkout@v4

      # ðŸ§© Step 2: Install dependencies
      - name: Install dependencies
        run: npm ci

      # ðŸ§© Step 3: Build application (simple version)
      - name: Build application
        run: |
          echo "ðŸ—ï¸ Building Node.js app..."
          npm run build || echo "â„¹ï¸ No build script found, skipping build."

      # ðŸ§© Step 4: Copy files to EC2
      - name: Copy project to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "."
          target: "/home/ubuntu/nodejs-ssl-server"

      # ðŸ§© Step 5: Deploy and restart the app on EC2 using PM2
      - name: Deploy & Restart on EC2
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd /home/ubuntu/nodejs-ssl-server

            echo "ðŸ“¦ Installing production dependencies..."
            rm -rf node_modules
            npm install --production

            echo "âš™ï¸ Checking for PM2..."
            if ! command -v pm2 >/dev/null 2>&1; then
              sudo npm install -g pm2
            fi

            echo "ðŸš€ Restarting application..."
            pm2 stop nodejs-ssl-server || true
            pm2 start app.js --name nodejs-ssl-server
            pm2 save

            echo "âœ… Deployment complete for $NODE_ENV environment!"
