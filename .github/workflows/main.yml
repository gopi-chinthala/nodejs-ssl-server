name: CI/CD - Node.js SSL Server Deployment (Final Stable Version)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  ci-cd:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: production

    steps:
      # -----------------------------
      # CI STAGE - Build & Security
      # -----------------------------

      - name: Checkout repository
        uses: actions/checkout@v4

      # 1ï¸âƒ£ GitLeaks - Free version (Secret Scanner)
      - name: Run GitLeaks via CLI (free version)
        run: |
          echo "ðŸ” Installing GitLeaks..."
          GITLEAKS_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | grep tag_name | cut -d '"' -f 4)
          curl -sSL -o gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/download/${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION#v}_linux_x64.tar.gz
          tar -xzf gitleaks.tar.gz
          sudo mv gitleaks /usr/local/bin/
          chmod +x /usr/local/bin/gitleaks

          echo "ðŸš€ Running GitLeaks scan..."
          gitleaks detect --source . --no-banner --redact || (echo "âŒ Secrets found! Fix them before deploying." && exit 1)

      # 2ï¸âƒ£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3ï¸âƒ£ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4ï¸âƒ£ Security Audit (vulnerability check)
      - name: Security Audit - Check for vulnerabilities
        run: |
          npm audit --production || echo "âš ï¸ Vulnerabilities found - please review later"

      # 5ï¸âƒ£ Build the application
      - name: Build the application
        run: |
          echo "ðŸ—ï¸ Building the project..."
          if [ -f package.json ] && grep -q "\"build\"" package.json; then
            npm run build
          else
            echo "â„¹ï¸ No build script found, skipping build step..."
          fi

      # -----------------------------
      # CD STAGE - Deploy to EC2
      # -----------------------------

      # 6ï¸âƒ£ Ensure target directory exists on EC2
      - name: Ensure deploy directory exists
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ðŸ§© Ensuring target directory exists..."
            sudo mkdir -p /home/ubuntu/nodejs-ssl-server
            sudo chown -R ubuntu:ubuntu /home/ubuntu/nodejs-ssl-server

      # 7ï¸âƒ£ Copy project files to EC2
      - name: Copy files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "."
          target: "/home/ubuntu/nodejs-ssl-server"

      # 8ï¸âƒ£ SSH into EC2 and deploy app
      - name: Deploy and Restart on EC2
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ðŸ” Connecting to EC2..."
            cd /home/ubuntu/nodejs-ssl-server

            echo "ðŸ§¹ Cleaning old dependencies..."
            rm -rf node_modules

            echo "ðŸ“¦ Installing production dependencies..."
            npm install --production

            echo "ðŸš€ Starting or restarting app with PM2..."
            if ! command -v pm2 &> /dev/null
            then
              sudo npm install -g pm2
            fi

            pm2 stop nodejs-ssl-server || true
            pm2 start server.js --name nodejs-ssl-server
            pm2 save

            echo "âœ… Deployment complete!"
