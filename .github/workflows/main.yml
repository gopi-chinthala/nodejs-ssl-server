name: CI/CD - Node.js SSL Server Deployment

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  ci-cd:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: production

    steps:
      # -----------------------------
      # CI STAGE - Build & Security
      # -----------------------------

      - name: Checkout repository
        uses: actions/checkout@v4

      # 1ï¸âƒ£ GitLeaks - Scan for exposed secrets
      - name: Run GitLeaks (Secrets Scanner)
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --source . --no-banner --redact
        continue-on-error: false  # Fail if secrets are detected

      # 2ï¸âƒ£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3ï¸âƒ£ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4ï¸âƒ£ Security Audit (vulnerability scan)
      - name: Security Audit - Check for vulnerabilities
        run: |
          npm audit --production || echo "âš ï¸ Vulnerabilities found - review later"

      # 5ï¸âƒ£ Run Build
      - name: Build the application
        run: |
          if [ -f package.json ] && grep -q "\"build\"" package.json; then
            npm run build
          else
            echo "No build step found, skipping..."
          fi

      # 6ï¸âƒ£ Run tests (if any)
      - name: Run tests
        run: |
          if [ -f package.json ] && grep -q "\"test\"" package.json; then
            npm test
          else
            echo "No tests defined, skipping..."
          fi

      # -----------------------------
      # CD STAGE - Deploy to EC2
      # -----------------------------

      # 7ï¸âƒ£ Copy files to EC2 instance
      - name: Copy files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "."
          target: "/home/ubuntu/nodejs-ssl-server"
          rm: true  # remove old files before copying (optional)

      # 8ï¸âƒ£ SSH into EC2 and deploy app
      - name: Deploy and Restart on EC2
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ðŸ” Connecting to EC2..."
            cd /home/ubuntu/nodejs-ssl-server

            echo "ðŸ“¦ Installing dependencies..."
            npm install --production

            echo "ðŸš€ Starting application with PM2..."
            if ! command -v pm2 &> /dev/null
            then
              sudo npm install -g pm2
            fi

            pm2 stop nodejs-ssl-server || true
            pm2 start server.js --name nodejs-ssl-server
            pm2 save

            echo "âœ… Deployment complete!"
